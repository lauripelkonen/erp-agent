# How to Create a Purchase Order with Lemonsoft API

This guide explains how to create and retrieve purchase orders using the Lemonsoft API, based on successful testing and implementation.

## Overview

The Lemonsoft API allows you to create purchase orders programmatically and retrieve them using filter parameters. This document covers the complete workflow from creation to retrieval.

## Key Discovery: Retrieval Method

⚠️ **Important:** Purchase orders cannot be retrieved using direct endpoints like `/api/purchaseorders/{id}`. Instead, you must use the **filter parameters** approach with the GET endpoint.

## API Endpoints

- **Create:** `POST /api/purchaseorders`
- **Retrieve:** `GET /api/purchaseorders` with filter parameters

## Step 1: Creating a Purchase Order

### Required Headers
```
Content-Type: application/json
Authorization: Bearer {your_token}
```

### Request Structure

```http
POST /api/purchaseorders
Content-Type: application/json

{
  "currency_code": "EUR",
  "delivery_date": "2025-12-31T00:00:00",
  "language_code": "FIN",
  "order_number": 20250708,
  
  "customer_number": 100001,
  "customer_name1": "SUPPLIER NAME",
  "customer_address1": "Supplier Address 1",
  "customer_address3": "00100 HELSINKI",
  "customer_contact": "Contact Person",
  "customer_country": "Finland",
  
  "delivery_customer_number": 100007,
  "delivery_customer_name1": "DELIVERY CUSTOMER NAME",
  "delivery_customer_address1": "Delivery Address 1",
  "delivery_customer_address3": "00200 HELSINKI",
  "delivery_customer_contact": "Delivery Contact",
  "delivery_customer_country": "Finland",
  
  "purchase_order_date": "2025-07-08T17:42:03",
  "currency_rate": 1,
  "payment_term": 0,
  "person_buyer_number": 113,
  "person_responsible_number": 0,
  "taxtype_bit": false,
  "ordered_bit": false,
  "state": 0,
  "type": 0,
  
  "rows": [
    {
      "product_code": "2018501",
      "product_name": "TEST PRODUCT 2018501",
      "quantity": 1,
      "unit": "KPL",
      "unit_price": 100.0,
      "sales_price": 100.0,
      "total": 100.0,
      "tax_rate": 25.5,
      "tax_amount": 25.5,
      "type": 0,
      "account": "4000",
      "cost_center": "",
      "to_be_delivered": 1,
      "delivered": 0,
      "per": 1,
      "position": "1"
    }
  ],
  
  "totalsum": 125.5
}
```

### Successful Response

```json
{
  "ok": true,
  "id": 94154,
  "has_errors": false,
  "errors": []
}
```

**Key Points:**
- The response contains an `id` field (e.g., 94154)
- The `order_number` field may be auto-generated by the system
- Always check `has_errors` to ensure success

## Step 2: Retrieving the Purchase Order

### Method 1: Using Purchase Order ID (Recommended)

Use the `id` returned from the creation response:

```http
GET /api/purchaseorders?filter.object_ids=94154
```

### Method 2: Using Order Number

If you know the order number:

```http
GET /api/purchaseorders?filter.order_numbers=207908
```

### Method 3: Search Recent Orders

Get recent purchase orders and search through them:

```http
GET /api/purchaseorders?filter.page_size=50&filter.sort_desc=true
```

### Successful Retrieval Response

```json
{
  "results": [
    {
      "purchase_order_id": 94154,
      "order_number": 207908,
      "state": 0,
      "currency_code": "EUR",
      "customer_number": 100001,
      "customer_name1": "SUPPLIER 100001",
      "delivery_customer_number": 100007,
      "delivery_customer_name1": "DELIVERY CUSTOMER 100007",
      "totalsum": 125.5,
      "purchase_order_date": "2025-07-08T17:42:03",
      "rows": [
        {
          "product_code": "2018501",
          "quantity": 1.0,
          "unit": "KPL"
        }
      ]
    }
  ],
  "result_count": 1,
  "has_next_page": false,
  "has_errors": false,
  "errors": []
}
```

## Python Implementation Example

```python
import asyncio
import json
from datetime import datetime, timedelta
from src.lemonsoft.api_client import LemonsoftAPIClient

async def create_and_retrieve_purchase_order():
    """Complete example of creating and retrieving a purchase order."""
    
    async with LemonsoftAPIClient() as client:
        # Step 1: Create purchase order
        current_time = datetime.now()
        order_number = int(f"2025{current_time.strftime('%m%d')}")
        
        po_data = {
            "currency_code": "EUR",
            "delivery_date": (current_time + timedelta(days=14)).strftime("%Y-%m-%dT%H:%M:%S"),
            "language_code": "FIN",
            "order_number": order_number,
            
            # Supplier (customer)
            "customer_number": 100001,
            "customer_name1": "SUPPLIER 100001",
            "customer_address1": "Test Address 1",
            "customer_address3": "00100 HELSINKI",
            "customer_contact": "TEST CONTACT",
            "customer_country": "Finland",
            
            # Delivery customer
            "delivery_customer_number": 100007,
            "delivery_customer_name1": "DELIVERY CUSTOMER 100007",
            "delivery_customer_address1": "Delivery Address 1",
            "delivery_customer_address3": "00200 HELSINKI",
            "delivery_customer_contact": "DELIVERY CONTACT",
            "delivery_customer_country": "Finland",
            
            # Order settings
            "purchase_order_date": current_time.strftime("%Y-%m-%dT%H:%M:%S"),
            "currency_rate": 1,
            "payment_term": 0,
            "person_buyer_number": 113,
            "taxtype_bit": False,
            "ordered_bit": False,
            "state": 0,
            "type": 0,
            
            # Products
            "rows": [{
                "product_code": "2018501",
                "product_name": "TEST PRODUCT 2018501",
                "quantity": 1,
                "unit": "KPL",
                "unit_price": 100.0,
                "sales_price": 100.0,
                "total": 100.0,
                "tax_rate": 25.5,
                "tax_amount": 25.5,
                "type": 0,
                "account": "4000",
                "to_be_delivered": 1,
                "delivered": 0
            }],
            
            "totalsum": 125.5
        }
        
        # Create purchase order
        response = await client.post('/api/purchaseorders', json=po_data)
        
        if response.status_code in [200, 201]:
            result = response.json()
            created_id = result.get('id')
            print(f"✅ Purchase order created with ID: {created_id}")
            
            # Step 2: Retrieve purchase order using filter
            params = {"filter.object_ids": created_id}
            get_response = await client.get('/api/purchaseorders', params=params)
            
            if get_response.status_code == 200:
                data = get_response.json()
                if data.get('results') and len(data['results']) > 0:
                    po = data['results'][0]
                    actual_order_number = po.get('order_number')
                    print(f"✅ Purchase order retrieved!")
                    print(f"   Order Number: {actual_order_number}")
                    print(f"   Purchase Order ID: {po.get('purchase_order_id')}")
                    print(f"   Total: {po.get('totalsum')} {po.get('currency_code')}")
                    return actual_order_number
        
        return None

# Run the example
if __name__ == "__main__":
    result = asyncio.run(create_and_retrieve_purchase_order())
    if result:
        print(f"Success! Order number: {result}")
```

## Filter Parameters Reference

The GET `/api/purchaseorders` endpoint supports these filter parameters:

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `filter.object_ids` | integer | Purchase order ID from creation response | `94154` |
| `filter.order_numbers` | integer | Order number (may be auto-generated) | `207908` |
| `filter.customer_number` | integer | Filter by supplier/customer number | `100001` |
| `filter.state` | integer | Filter by order state | `0` |
| `filter.type` | integer | Filter by order type | `0` |
| `filter.ordered_before` | datetime | Orders created before date | `2025-12-31T00:00:00` |
| `filter.ordered_after` | datetime | Orders created after date | `2025-01-01T00:00:00` |
| `filter.page` | integer | Page number (default: 1) | `1` |
| `filter.page_size` | integer | Items per page (default: 10) | `50` |
| `filter.sort_desc` | boolean | Sort in descending order | `true` |

## Important Notes

### Order Number Behavior
- **Input:** You can provide an `order_number` in the POST request
- **Output:** The system may auto-generate a different order number
- **Example:** Input `20250708` → System generates `207908`
- **Always use the returned ID for retrieval, not your input order number**

### Required Fields
- `currency_code`, `language_code`
- `customer_number` (supplier), `delivery_customer_number`
- `purchase_order_date`, `currency_rate`
- `rows` array with at least one product
- `totalsum` (calculated total including tax)

### Common Issues
1. **Cannot retrieve directly:** Don't use `/api/purchaseorders/{id}` - it will return "Purchase Order with given ID does not exist"
2. **Use filters:** Always use `/api/purchaseorders` with filter parameters
3. **Check has_errors:** Always verify the response doesn't contain errors
4. **Order number mismatch:** Use the `id` from creation response, not your input order number

## Testing Your Implementation

1. Create a purchase order and note the returned `id`
2. Immediately try to retrieve it using `filter.object_ids={id}`
3. Verify all required fields are present in the response
4. Check that supplier, delivery customer, and products match your input

## Error Handling

```python
# Always check for errors in responses
if response.status_code in [200, 201]:
    result = response.json()
    if result.get('has_errors'):
        errors = result.get('errors', [])
        for error in errors:
            print(f"Error: {error.get('message')}")
    else:
        # Success - proceed with result
        created_id = result.get('id')
```

## Summary

1. **Create:** POST to `/api/purchaseorders` with complete order data
2. **Get ID:** Extract `id` from the successful response  
3. **Retrieve:** GET `/api/purchaseorders?filter.object_ids={id}`
4. **Extract Order Number:** Get `order_number` from the retrieved data

This approach ensures reliable purchase order creation and retrieval using the Lemonsoft API. 